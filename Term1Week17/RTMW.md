# RTMW

## 摘要

全身姿态估计是一项具有挑战性的任务，需要同时预测身体、手部、面部和脚部的关键点。全身姿态估计旨在为人类身体（包括面部、躯干、手部和脚部）提供精细的姿态信息，这在以人为中心的感知与生成研究及各种应用中起着重要作用。在这项工作中，我们提出了RTMW（实时多人全身姿态估计模型），一系列用于2D/3D全身姿态估计的高性能模型。我们在RTMPose模型架构中加入了FPN和HEM（分层编码模块），以更好地捕获来自不同身体部位和不同尺度的姿态信息。该模型通过手动对齐注释的丰富开源人体关键点数据集进行训练，并通过两阶段蒸馏策略进一步增强。RTMW在多个全身姿态估计基准测试中表现出色，同时保持了高推理效率和部署友好性。我们发布了三种规模的模型：m/l/x，其中RTMW-l在COCO-WholeBody基准测试中达到了70.2的mAP，成为首个在该基准上超过70 mAP的开源模型。同时，我们探索了RTMW在3D全身姿态估计任务中的表现，通过基于坐标分类的方式进行基于图像的单目3D全身姿态估计。我们希望这项工作能同时惠及学术研究和工业应用。代码和模型已公开发布，网址为：
 https://github.com/open-mmlab/mmpose/tree/main/projects/rtmpose

## 引言

全身姿态估计是推进以人为中心的人工智能系统能力的重要组成部分。它可用于**人机交互**、**虚拟角色动画**以及**电影产业**等领域。在AIGC（AI生成内容）应用中，全身姿态估计的结果也被用于控制角色生成。随着下游任务和工业应用对全身姿态估计的需求不断增加，设计一种**高精度、低延迟且易于部署**的模型极具价值。

在早期的人体姿态估计研究中，由于任务的复杂性以及计算能力和数据的限制，研究人员将人体分为独立的部分进行单独的姿态估计研究。经过前人的不懈努力，这些单一的、针对具体部位的2D姿态估计任务已经取得了显著成果。

诸如OpenPose [3] 之类的先前工作通过结合这些独立部分的结果可以实现全身姿态估计。然而，这种直接组合的方法面临高计算成本和显著的性能限制。虽然像MediaPipe [22] 这样的轻量级工具在**实时性能**和**部署便捷性**方面表现出色，但其**精度**仍然存在不足。

我们的MMPose [5] 团队去年发布了RTMPose [10] 模型，该模型在精度和实时性能之间实现了出色的平衡。随后，在此基础上，DWPose [40] 通过引入两阶段蒸馏技术并整合新数据集UBody [17]，进一步提升了RTMPose在全身姿态估计任务中的表现。

RTMPose [10] 的结构设计最初仅考虑了身体姿态。然而，在全身姿态估计任务中，特征分辨率对于面部、手部和脚部的姿态精度至关重要。因此，我们引入了两项技术，PAFPN（部分聚合特征金字塔网络）和HEM（高效多尺度特征融合），以提升特征分辨率。实验结果表明，这两个模块显著提高了精细身体部位的定位精度。

与此同时，开源全身姿态估计数据集的匮乏极大地限制了开源模型的性能。为充分利用针对不同身体部位的数据集，我们手动对14个开源数据集（3个全身关键点数据集、6个身体关键点数据集、4个面部关键点数据集以及1个手部关键点数据集）的关键点定义进行了对齐，并联合使用这些数据集对RTMW进行训练。

在3D全身姿态估计领域，学术界主要采用两种方法论：提升法（Lifting）[26, 29, 42] 和回归法（Regression）[28, 32]。基于SimCC [16] 技术的方法尚属空白。我们的研究尝试将RTMW架构应用于3D全身姿态估计任务。实验结果表明，SimCC [16] 方法在该领域具有良好的性能和应用潜力。

## 相关工作

**自顶向下的方法**
 自顶向下算法使用现成的检测器提供边界框并将人体裁剪到统一的比例以进行姿态估计。自顶向下范式的算法 [2,18,31,37,39] 主导了公共基准测试。这种两阶段推理范式允许人体检测器和姿态估计器使用相对较小的输入分辨率，从而在非极端场景（例如图像中人数不超过6人时）中，其速度和精度都优于自底向上算法。此外，大多数现有工作主要专注于在公共数据集上实现最先进的性能。相比之下，我们的工作旨在设计具有更好速度与精度权衡的模型，以满足工业应用的需求。

**坐标分类**
 以往的姿态估计方法通常将关键点定位视为坐标回归（例如 [14, 25, 33]）或热图回归（例如 [8, 37, 39, 41]）。SimCC [16] 引入了一种新的方案，将关键点预测表述为对水平和垂直坐标的亚像素网格分类，从而带来了若干优势。首先，SimCC 摆脱了对高分辨率热图的依赖，因此可以采用非常紧凑的架构，无需高分辨率中间表示 [31] 或昂贵的上采样层 [37]。其次，SimCC 展平最终特征图进行分类，而不是涉及全局池化 [33]，因此避免了空间信息的丢失。第三，通过亚像素级别的坐标分类，量化误差可以得到有效缓解，而无需额外的后处理精细化步骤 [41]。这些特点使SimCC在构建轻量级姿态估计模型方面极具吸引力。RTMO [21] 将坐标分类方法引入单阶段姿态估计，显著提升了性能，同时证实了SimCC方法在姿态估计任务中的巨大潜力。在本工作中，我们进一步利用了坐标分类方案，并对模型架构和训练策略进行了优化。

**3D姿态估计**
 3D姿态估计是一个充满活力的研究领域，具有广泛的工业应用。当代方法主要分为两大类：

- **提升法（Lifting Methods）** [26, 29, 42]：利用2D关键点，通过神经网络直接预测其空间坐标。该方法以计算速度快为特点。然而，这种效率是以场景信息为代价的，因为这些算法不输入图像，因此依赖于训练数据的标注范围进行预测。
- **基于图像的回归方法（Image-Based Regression Methods）** [28, 32]：虽然整合了丰富的视觉数据，但面临推理速度慢、任务复杂性增加的挑战。这些因素导致模型训练难度较大，精度提升受限。

我们提出的方法RTMW3D，与传统方法不同，通过基于SimCC技术 [16] 的分类策略来优化最终的空间坐标预测。实验结果证明了这一创新方法的有效性。

## **模型架构与训练**

尽管我们之前提出的RTMPose并未针对全身关键点估计任务进行特别设计，但实验表明，其性能与当前最先进的方法ZoomNas [38] 相当。然而，在实验过程中，我们发现RTMPose在全身姿态估计任务中存在一定的性能瓶颈。随着参数规模的增加，模型性能并未随参数数量的增加而显著提升。另一方面，尽管其他研究团队（如DWPose团队）在训练RTMPose时引入了新数据集，并采用了更高效的两阶段蒸馏训练技术，从而有效提升了RTMPose的精度，但仍无法避免RTMPose在参数数量增加时的固有性能瓶颈。

------

### **3.1 RTMW**

#### **3.1.1 任务局限性**

 我们首先分析了全身姿态估计任务中尚未解决的问题，并针对这些挑战设计了RTMW模型。

1. **局部区域的分辨率限制**：在一张图像中，人体的面部、手部和脚部等部位占整个身体和图像的比例很小。对于模型而言，这些区域的输入分辨率将直接影响模型对这些部位关键点的预测精度。
2. **不同身体部位关键点学习的难度差异**：例如，面部关键点可以被视为附着在面部（刚体）上的一些点，由于面部变形较小，模型更容易学习预测这些关键点。相比之下，由于手指和手腕的旋转和移动具有更高的自由度，手部关键点的预测难度更大。
3. **损失函数问题**：常用的损失函数（如KL散度和回归误差）通常是逐点计算的，因此往往被具有更多关键点和更大空间比例的身体部位（如躯干和面部）主导，而对手部和脚部等小而复杂的部位关注不足。这通常导致收敛不平衡，表现为平均误差较低但复杂身体部位的精度较差。
4. **数据集稀缺问题**：开源全身姿态估计数据集极少，这显著限制了对模型能力的研究。

针对上述局限性，我们为RTMPose设计了一系列针对性的优化方案，并提出了RTMW模型。

------

#### **3.1.2 模型架构**

 RTMW模型的结构如图1所示，基于RTMPose设计，结合了PAFPN [19] 和HEM模块以增强特征分辨率。其中：

- **FPN（特征金字塔网络）：** 一种有效提升特征分辨率的技术，广泛应用于密集预测任务的模型结构中。
- **HEM（分层编码模块）：** 受VQVAE-2 [30] 提出的分层编码概念启发，我们引入了HEM模块。实验结果表明，同时引入这两个模块可以显著提升RTMPose在全身姿态估计任务中的性能。

**PAFPN**
 在之前的分析中，由于我们强调了各种身体部位输入分辨率对模型预测精度的影响，因此自然引入了FPN模块。这一技术在其他视觉任务（如目标检测任务）中非常常见。有关该模块的详细信息可参考原论文 [19] 和RTMDet [24] 中使用的改进版本。

**HEM（分层编码模块）**
 该模块的灵感来源于VQVAEv2的工作，该工作在原有的编码器-解码器架构基础上引入了分层概念。在原始VQVAE中，生成的图像缺乏清晰和丰富的细节。因此，在第二版中，他们对不同分辨率的特征进行了分层编码，并在解码过程中分别解码这些分层特征，从而丰富了生成图像的细节。受此启发，我们在RTMW的设计中创建了HEM模块，该模块对PAFPN输出的特征进行分层SimCC编码，然后在分层编码后进行合并，并最终在解码器中解码。实验表明，该设计能够提高人体姿态估计中低分辨率身体部位的预测精度。

------

#### **3.1.3 训练技术**

 由于开源全身姿态估计数据集的匮乏，我们手动对齐了14个包含全身、躯干、手部和面部关键点的开源数据集，并利用这些数据集进行联合训练。同时，为了最大化模型性能，我们在模型训练过程中采用了DWPose中使用的两阶段蒸馏技术，以进一步增强模型性能。

------

### **3.2 RTMW3D**

 我们进一步探索将RTMW架构扩展到3D全身姿态估计任务，这是一项因其病态特性而具有挑战性的任务。具体而言，尽管从单目RGB图像中确定关键点的x和y坐标较为直观，但z轴的模糊性增加了模型学习的复杂性。此外，缺乏标注关键点的开源3D人体姿态数据集以及现有数据集场景多样性的限制严重影响了模型的性能和泛化能力。

为了解决这些挑战，RTMW3D针对单目3D姿态估计任务进行了优化，通过对3D数据集的精细化处理、重新定义z轴以及缓解预测z轴坐标的学习难度，显著提升了性能。在结构上，RTMW3D与RTMW高度相似，主要增加了一个用于z轴预测的分支到解码器头部。

**任务定义**
 RTMW3D遵循2D姿态估计的原则，直接在SimCC坐标空间上预测关键点的x和y坐标。根据SimCC [16] 方法的设计（如图2所示），对于z轴，我们未直接使用数据集中标注的z轴坐标，而是为人体骨架定义了一个根点，并计算关键点相对于该根点的z轴偏移量。这种创新方法标准化了不同数据集的z轴，并简化了模型的学习难度。

**数据处理**
 鉴于缺乏以关键点为中心的3D人体姿态数据集，我们实施了一种融合2D和3D数据集的协同训练策略。此方法通过多样化的场景丰富了数据，从而提高了模型在2D姿态估计任务中的性能。为了解决2D关键点数据集中缺乏z轴标注的问题，我们在2D关键点数据中引入了z轴掩码。这一改进实现了2D和3D数据的统一训练协议，使模型能够准确预测关键点的x和y坐标，同时增强其2D姿态估计能力。

## **实验**

------

### **4.1 数据集**

 在训练阶段，我们继续使用RTMPose中采用的所有训练技术，并引入了DWPose提出的两阶段蒸馏技术。由于开源全身姿态估计数据集的有限性，我们整合了14个不同部分的数据集，手动对齐关键点定义，并统一映射到COCO-WholeBody的133点定义。在单目3D全身姿态估计任务中，由于缺乏开源3D数据集，我们结合了14个现有的2D数据集和3个开源3D数据集，共使用了17个数据集进行联合训练。我们使用的数据集如下：

- **3个全身数据集**：COCO-WholeBody [11, 38]，UBody [17]，Halpe [6]
- **6个人体数据集**：AIC [7]，CrowdPose [15]，MPII [1]，sub-JHMDB [9]，PoseTrack18 [37]，HumanArt [13]
- **4个面部数据集**：WFLW [36]，300W，COFW，LaPa [20]
- **1个手部数据集**：InterHand [27]
- **3个3D全身关键点数据集**：H3WB [43]，UBody [17]，DNA-rendering [4]

有关详细的映射关系，请参阅附录。我们按照DWPose [40] 提出的流程对RTMW进行了两阶段蒸馏，相关超参数设置与DWPose一致。

------

### **4.2 结果**

**COCO-WholeBody**
 我们在COCO-WholeBody [12, 38] V1.0数据集上验证了所提出的RTMW模型在全身姿态估计任务中的性能。如表1所示，RTMW在性能和复杂性之间实现了出色的平衡。此外，我们提出的RTMW3D在COCO-WholeBody上也表现出良好的性能。

**H3WB**
 H3WB [43] 是目前唯一一个提供测试集的开源3D全身姿态估计数据集。我们在H3WB测试集上评估了RTMW3D的性能，结果如表2所示。同样，RTMW3D在H3WB数据集上取得了优异的性能。

**推理速度**
 由于我们的主要目标是开发实时模型，推理速度成为关键的性能指标。RTMW模型的推理速度评估结果详见表3。尽管RTMW相较于RTMPose增加了额外模块，推理速度略有下降，但精度有了显著提升。这种权衡在我们的目标范围内是可以接受的。

------

### **4.3 消融实验**

#### **4.3.1 RTMW消融实验**

 我们测试了RTMW各模块对性能的影响，结果如表4所示。模型在COCO-WholeBody [12, 38]、UBody [17] 和Halpe [6] 数据集上训练，输入大小为256×192。实验结果表明，PAFPN和HEM模块显著提升了预测精度，特别是在低输入分辨率的身体部位（如手部和脚部），预测精度的提升尤为明显。

------

### **4.4 可视化结果**

 图3和图4展示了RTMW和RTMW3D模型的推理结果的可视化表示。这些图像说明了RTMW和RTMW3D模型的性能相当出色，与定量评估数据一致。

## **结论**

本文通过批判性地研究全身姿态估计任务的复杂性和挑战，拓展了现有的学术工作。基于我们已建立的RTMPose模型，我们提出了一个改进的高性能模型——RTMW/RTMW3D，用于实时全身姿态估计。我们的模型在所有开源替代方案中表现出色，并具备独特的单目3D姿态估计能力。我们期望所提出的算法及其开源特性能够满足工业领域对稳健姿态估计解决方案的诸多实际需求。