# Development and validation of machine learning algorithms based on electrocardiograms for cardiovascular diagnoses at the population level

## 摘要

人工智能支持的心电图（ECG）算法在心血管（CV）疾病的早期检测中日益重要，特别是能够检测到传统ECG测量或专家解释无法识别的疾病。该研究开发并验证了这些模型，旨在同时预测15种常见的心血管疾病，研究对象为整个人口群体。我们进行了一项回顾性研究，研究纳入了2007年2月至2020年4月期间在加拿大艾伯塔省84家急诊科或医院接受至少一次12导联心电图的244,077名成人患者的1,605,268份心电图记录，并对15种心血管疾病进行了研究，这些疾病通过国际疾病分类第10版（ICD-10）代码识别：心房颤动（AF）、室上性心动过速（SVT）、室性心动过速（VT）、心脏骤停（CA）、房室传导阻滞（AVB）、不稳定型心绞痛（UA）、ST段抬高型心肌梗死（STEMI）、非ST段抬高型心肌梗死（NSTEMI）、肺栓塞（PE）、肥厚型心肌病（HCM）、主动脉瓣狭窄（AS）、二尖瓣脱垂（MVP）、二尖瓣狭窄（MS）、肺动脉高压（PHTN）和心力衰竭（HF）。==我们采用基于ResNet的深度学习（DL）模型分析心电图波形，并采用极端梯度提升（XGB）模型分析心电图测量数据==。在对97,631名测试患者的首个心电图进行评估时，DL模型对3种心血管疾病（PTE、SVT、UA）的受试者工作特征曲线下面积（AUROC）<80%，对8种心血管疾病（CA、NSTEMI、VT、MVP、PHTN、AS、AF、HF）的AUROC在80-90%之间，对4种心血管疾病（AVB、HCM、MS、STEMI）的AUROC>90%。DL模型的AUROC平均比XGB模型高约5%。总体而言，基于心电图的预测模型在诊断常见心血管疾病时表现出了良好至卓越的预测性能。

## 引言

12导联心电图（ECG）是诊断心血管（CV）疾病最常见、低成本且便捷的工具。几乎所有急诊都会进行心电图检查，而且通常不止一次。仅在美国，每年就有超过1亿次心电图检查。这很有用，因为心电图包含大量信息，通过心脏电活动产生的形态和时间特征，可以深入了解潜在的心脏生理状况。然而，医生和计算机算法用来解读心电图的标准技术存在局限性，很多技术是基于规则的，只考虑了心电图中可用信息的一小部分。手动或计算机化方法，甚至传统的统计方法，都无法解释来自多个导联的心电图信号之间的高级交互作用，也无法识别可能表明早期疾病的难以察觉但具有信息量的变化。深度学习（DL）分析的出现，为识别心电图信号中临床相关但“隐藏”的模式提供了令人兴奋的机会，并可以同时评估常规采集的临床数据中的复杂交互关系，以诊断各种心血管异常。

先前关于使用心电图进行疾病预测的机器学习模型研究，主要集中在基于心电图模式的形态学变化，专家医生可以轻松解读的心脏疾病上，例如心律失常（如心房颤动［AF］、室性心动过速［VT］、室上性心动过速［SVT］），ST段抬高型心肌梗死（STEMI）或非ST段抬高型心肌梗死（NSTEMI），或者心脏传导阻滞，如房室传导阻滞或分支阻滞，包括左束支传导阻滞和右束支传导阻滞。虽然使用心电图数据来预测那些传统上不与心电图模式相关的心血管疾病的机器学习模型数量仍然有限，但这种趋势正在逐步增加。这些模型关注的疾病包括二尖瓣脱垂（MVP）、心脏骤停（CA）、心力衰竭（HF）、肺栓塞（PE）、主动脉瓣狭窄（AS）、二尖瓣狭窄（MS）、肺动脉高压（PHTN）和肥厚型心肌病（HCM）。此外，==现有研究主要集中在单一标签的预测，尚未有研究开发一个预测系统，能够同时检测这些特定疾病==。由于缺乏大型临床标注的医疗数据集来进行监督机器学习，这是一个公认的问题，而在人口规模上进行大规模验证，对于展示预测模型的可信度至关重要，因为这对于将模型成功应用于临床实践非常重要，在那里，早期识别和治疗可能会影响疾病并发症、医疗使用和成本。

因此，我们使用来自单一支付者的全民健康系统的大规模人口队列，==开发并验证了基于12导联心电图波形的深度学习（DL）模型，以及基于常规采集的心电图测量值的极端梯度提升（XGB）模型，以通过统一的预测框架同时预测15种常见的心血管疾病。==

## 结果

**患者特征与结局**  
该队列的基线特征已在之前的研究中描述。简而言之，患者的平均年龄为65.8 ± 17.3岁，56.7%为男性（补充表1）。模型通过来自146,446名患者的心电图进行训练，并随后在97,631名患者的保留队列中进行评估（图1）。保留数据集中包含53,436名男性和44,195名女性，用于性别差异的性能评估。此外，对96,164名没有心脏起搏器的患者进行了单独评估，以探讨心脏起搏器对模型性能的影响。为了预测系统在实际应用中的效果，我们仅使用每位保留患者在特定就诊时的第一次心电图进行评估。

表1展示了在完整数据集、开发集、保留集以及保留集中每次就诊的第一次心电图中选定心血管疾病的心电图频率和百分比。保留集中每次就诊的第一次心电图（用于最终评估）的诊断标签与完整数据相比有一些差异（例如，心力衰竭的频率：9.3% vs 15.5%；房颤：11.5% vs 18.2%）。

**模型性能与比较**  
图2、表2和补充表2展示了DL模型和XGB模型（心电图波形数据与是否包含年龄和性别特征，心电图测量值包含年龄和性别特征）对于15种心血管疾病的模型性能比较。在我们主要模型（DL：心电图波形数据，年龄，性别）的保留验证中，STEMI的模型表现最好，受试者工作特征曲线（AUROC）为95.5%，而肺栓塞（PTE）的模型表现最差，AUROC为68.9%。除了PTE外，所有诊断的AUROC均超过76%：AUROC小于80%的有两种疾病（SVT和UA，按升序排列）；AUROC在80-90%之间的有八种疾病（心脏骤停、NSTEMI、VT、二尖瓣脱垂、肺动脉高压、主动脉瓣狭窄、房颤、心力衰竭，按升序排列）；AUROC超过90%的有四种疾病（房室传导阻滞、肥厚型心肌病、二尖瓣狭窄、STEMI，按升序排列）。房颤的模型在精准召回曲线下面积（AUPRC）得分最高，为59.2%（F1得分：51.6%），其次是心力衰竭，AUPRC为56.1%（F1得分：46.6%），STEMI的AUPRC为54.3%（F1得分：39.2%）。

DL模型（心电图波形数据，年龄，性别）的表现优于XGB模型（心电图测量值，年龄，性别），除了房室传导阻滞，两者表现相近。DL模型的AUROC平均比XGB模型提高了5.2%，其中MS提高了11.8%，MVP提高了8.6%，NSTEMI提高了7.3%，STEMI提高了7.1%。通过95%置信区间的自举结果比较，显示除了PTE外，DL模型中加入年龄和性别特征可以为所有诊断带来小但显著的改进。同样，自举结果显示，单独使用心电图波形的DL模型在除房室传导阻滞、肥厚型心肌病和VT外，均优于使用心电图测量值、年龄和性别的XGB模型。

**基于性别的模型性能**  
我们对DL模型（心电图波形数据，年龄，性别）在保留集中分别针对男性和女性进行了性能评估，整体结果相似（图3，顶部面板）。在15种疾病中，10种疾病的模型对男性表现略好，AUROC平均提高1.0%。其中五种疾病—即VT、STEMI、PTE、心力衰竭和主动脉瓣狭窄—显示出显著差异。模型在VT中的差异最大，男性表现比女性高6.4%（男性：85.1%，女性：78.7%），AUPRC差异为14.8%（男性：37.5%，女性：22.6%）。相比之下，房颤的预测性能在女性中的AUROC比男性高1.2%。

**基于心脏起搏器存在的模型性能**  
在评估保留集中排除装有心脏起搏器及其他植入性心脏设备患者的心电图后，DL（心电图波形、年龄、性别）模型的性能与总体评估相当，排除这些心电图后的平均AUROC仅提高了0.25%（图3，底部面板）。在这种情况下，VT表现出最大差异，排除心脏起搏器心电图后AUROC下降了3.2%，AUPRC下降了5.6%。另一种显示显著差异的诊断是房室传导阻滞（AVB），AUROC下降了1.6%，AUPRC下降了5.7%。

**“逐一排除医院”验证**  
本研究使用了来自14家医院的心电图数据。其中两家是三级护理医院，贡献了最多的心电图数量（分别为487,042份和453,085份）。我们对每一家三级医院（H1和H2）进行了“逐一排除医院”的验证，即在排除验证医院的情况下，使用其他医院的数据进行训练（补充图1）。“逐一排除医院”验证中DL模型（心电图波形、年龄、性别）的性能与保留集的总体结果相当（补充表3）。与主要验证结果相比，H1的平均AUROC在15种疾病中提高了1.38%，而H2的AUROC则下降了1.34%。

**所有心电图的保留集评估**  
作为对DL模型的额外验证，我们评估了其在保留集中所有获取的心电图（而不仅仅是每次就诊的第一次心电图）上的性能。补充表4列出了结果，显示性能要么优于、要么与仅使用首次心电图时的表现相当。

在所有心电图的评估中，AUROC和AUPRC得分有所波动。平均AUROC（15种疾病的平均值）总体下降了2.04%，而AUPRC则同时提高了2.15%。值得注意的是，在所有心电图评估中，所有标签的F1得分均有所提升，提升范围为1.09%至16.81%，平均提升为6.28%。同样，所有标签的阳性预测值（PPV或精准度）也有所提高，提升范围为0.56%至15.32%，平均提升为4.98%。因此，可以预期这些算法在任何时间点采集的心电图上表现将与首次心电图的表现相当，甚至更优。

**组合标签评估**  
由于样本中某些诊断的患病率较低（例如，首次心电图中二尖瓣狭窄的患病率为0.09%），这可能会影响阳性预测值（PPV）。因此，我们探索了一种基于组合标签的替代评估方案，这在筛查过程中曾被用于提高诊断率。我们创建了一个组合标签：如果15种心血管疾病中的任何一种为阳性，则组合标签为阳性；如果所有疾病均为阴性，则组合标签为阴性。

我们重新评估了多标签DL模型预测组合标签阳性心电图的能力。结果显示PPV为31.64%，F1得分为47.39%。随后，我们使用相同的模型架构训练了一个以组合标签为监督的新模型，并在相同的保留集上评估其性能。结果显示PPV为57.9%，F1得分为63.03%。这些结果表明，当筛查组合结果时，可以实现更高的PPV。

**模型解释**  
图4展示了GradCAM的结果，突出显示了对不同心血管疾病预测贡献较大的心电图区域（补充图2列出了所有15种诊断的完整列表）。值得注意的是，对诊断贡献最大的区域包括：STEMI的PR间期和QRS波群，NSTEMI的T波，PHTN的QRS波群，非持续性VT患者中的VT波，AS的QRS波群，AVB的P波，心力衰竭中的ST段区域。

图5显示了基于心电图测量值的XGB模型的特征重要性分析，揭示了多种特征在不同心血管疾病预测中的信息增益。例如，房颤的预测与P波持续时间密切相关，SVT与心率相关，UA与RR间期相关，AVB与QRS持续时间相关，心力衰竭与正前方T轴相关，NSTEMI与水平T轴相关，心脏骤停与Bazett校正的QT间期相关等。

## **讨论**

在这项基于大规模人群的研究中，我们利用数百万份心电图和关联的行政健康记录，开发并验证了基于机器学习（ML）的预测模型，以诊断包括之前未在心电图预测研究中探索的常见心血管（CV）疾病。研究结果表明，深度学习（DL）和极端梯度提升（XGB）模型在大多数心血管疾病的预测中表现良好至优秀，而DL模型的表现优于XGB模型。

先前的研究已经表明，AI驱动的心电图诊断可以准确识别心电图中的节律和形态异常，但这些研究未能深入探讨其在检测心电图未常规诊断的心脏病中的表现【26】。本研究证明了标准ML技术如何利用简单且易获取的12导联心电图，不仅能够准确预测心血管疾病，还能预测那些通常不依赖心电图进行诊断的疾病。这些模型有望成为早期筛查心血管疾病的工具，尤其是那些对医疗系统造成巨大负担的疾病，帮助更早识别临床上重要的心血管问题【27-29】。更重要的是，这些自动分类系统的使用可以在医疗资源有限、缺乏心脏科专家的偏远地区提高护理的可及性。未来的研究应探讨如何将基于心电图的自动筛查系统应用于疾病的早期管理和预防，从而提供成本效益高的护理服务。

DL模型是拥有数百万参数的复杂算法，通常在小数据集上训练时容易过拟合【30-32】。即使拥有大型医疗数据集，它们通常也是未标注的，这对监督学习方法构成了进一步的挑战【33】。本研究利用的阿尔伯塔心电图数据集包含了12导联的金标准心电图，并与人群水平数据相链接【25,34】。这种广泛包含人口统计学和临床协变量的数据环境，为开发基于心电图的ML算法预测常见心血管疾病提供了理想条件。此外，本研究重点分析了患者首次医疗接触时的心电图数据，模拟了实际的医疗场景。

我们的DL模型在15种疾病中有12种表现出C-index或AUROC >80%，4种疾病的AUROC >90%（包括STEMI、二尖瓣狭窄、肥厚型心肌病和房室传导阻滞）。DL模型的预测精度优于基于常规心电图测量值的XGB模型，除了房室传导阻滞的预测表现相当外，其它疾病的DL模型均有更好的预测表现。在二尖瓣病的预测中，DL模型的表现提升了11.8%；而在心肌梗死的检测中，提升了7.3%。值得注意的是，我们进一步评估了模型在性别群体、使用心脏起搏器或左心室辅助装置（LVAD）的情况下的稳健性，发现DL模型在这些情况下表现同样稳定，甚至在包含起搏器患者的心电图时表现更佳。

本研究也有一些限制需要讨论。首先，所有心电图均由同一制造商（飞利浦智能系统）生成，这可能限制了研究结果对其他系统心电图的普适性。其次，XGB模型使用的心电图测量值由飞利浦机器提供，并非通过核心实验室读取或人工专家校验。第三，我们的标签来自急诊和住院记录中的ICD代码。由于行政医疗记录的数据收集性质，无法确定疾病在医疗过程中的确切发生时间。因此，在极少数情况下，如果急性疾病在首次心电图采集后才发生，则我们的预测任务可以被解释为早期检测，而非现有疾病的诊断。这一区别仍具有临床价值，因为早期检测能够提供对未来可能并发症的洞察，对于住院护理也同样有益。

第四，尽管我们进行了大规模的内部测试，但仍需进行外部验证。单一健康系统的固有偏差可能会在类似患者群体、设备、标签生成程序等方面被延续。不幸的是，由于没有适合的外部心电图数据集与选定的ICD-10诊断标签相关联，我们无法提供多标签模型的外部验证。然而，我们的DL：ECG、年龄、性别模型的“留一医院验证”结果表明，模型在不同医院间具有较强的稳健性。

第五，本研究基于急诊和住院患者的真实世界队列，不同诊断的患病率存在差异，这可能解释了某些疾病的预测精度较高，而其他疾病较低。我们并未对数据进行增强或操作，因为我们的目标是最终将这些模型部署到电子病历系统中。此外，尽管我们的训练数据集包含近百万份心电图，且阳性病例数量足够多，但某些标签的PPV可能仍低于理想水平，因此在临床部署时需慎重考虑。第六，我们主要使用AUROC或C-index作为评估指标，这在生物医学文献中很常见，但该指标有局限性，未考虑假阳性或假阴性的误分类成本。模型部署时，应优先考虑自定义评估，以最小化预期成本，并考虑误分类成本和其他资源分配因素【35】。

尽管某些ML方法具有黑箱性质，但我们使用了GradCAM分析DL模型（以及SHAP分析XGB模型），以识别对心血管疾病诊断有贡献的心电图模式（或心电图测量值）。

总之，通过综合性的人口水平数据库分析，我们证明了基于心电图的DL和XGB预测模型在诊断常见心血管疾病方面表现出良好至优秀的预测性能。在所研究的疾病中，DL模型的预测精度优于基于常规心电图测量的XGB模型。模型在不同性别群体以及有无起搏器或LVAD的患者中表现相当。未来研究需探讨这些模型如何在临床实践中用于早期诊断和风险分层。

## **方法**

**数据来源** 
本研究在加拿大阿尔伯塔省进行，该省拥有单一支付者的医疗系统，提供全民医疗服务，并能100%捕捉所有与医疗系统的互动数据。心电图（ECG）数据通过唯一的患者健康编号与以下行政健康数据库进行了关联：(1) 住院出院摘要数据库（DAD），该数据库包含住院数据；(2) 国家门诊护理报告系统（NACRS）数据库，涵盖所有基于医院的门诊诊所和急诊科（ED）就诊记录；以及(3) 阿尔伯塔省医疗保险计划注册表（AHCIP），提供人口统计信息。

**心电图数据** 
我们使用了标准的12导联心电图波形（电压-时间序列，采样频率为500 Hz，每12个导联各记录10秒）和通过Philips IntelliSpace ECG系统的内置算法自动生成的心电图测量值。心电图测量值包括：心房率、心率、RR间期、P波持续时间、P波轴（额面和水平面）、PR间期、QRS持续时间、QRS轴（初始40毫秒、末端40毫秒，额面和水平面）、ST波轴（额面和水平面）、T波轴（额面和水平面）、Q波起点、Fridericia校正QT间期、QT间期和Bazett校正QT间期。

**分析队列** 
研究队列已经在先前文献中描述过【25】。简要来说，研究队列包括2007年2月至2020年4月期间在阿尔伯塔省14个医院住院的患者，共有来自3,336,091次急诊就诊和1,071,576次住院的2,015,808份心电图记录。对于同一患者在48小时内发生的并发医疗接触（急诊和/或住院），将其视为转院，并视为同一医疗事件。如果某份心电图的采集日期在住院期间，则其与该医疗事件相关联。排除未能与任何医疗事件关联的心电图、18岁以下患者的心电图，以及被ECG设备内置质量算法标记为信号质量差的心电图后，最终分析队列包含244,077名患者748,773次医疗事件中的1,605,268份心电图（见图1）。

**预测任务** 
我们开发并评估了基于心电图的模型，==预测患者患有15种特定常见心血管疾病的概率==，包括：房颤（AF）、室上性心动过速（SVT）、室性心动过速（VT）、心脏骤停（CA）、房室传导阻滞（AVB）、不稳定型心绞痛（UA）、非ST段抬高型心肌梗死（NSTEMI）、ST段抬高型心肌梗死（STEMI）、肺栓塞（PTE）、肥厚型心肌病（HCM）、主动脉瓣狭窄（AS）、二尖瓣脱垂（MVP）、二尖瓣狭窄（MS）、肺动脉高压（PHTN）和心力衰竭（HF）。这些疾病是基于与特定ECG记录关联的医疗事件中的国际疾病分类（ICD10）代码识别的【36,37】。如果在急诊或住院期间进行了心电图检查，我们将所有相关的诊断视为该心电图的阳性结果。某些诊断（如AF、SVT、VT、STEMI和AVB）通常通过心电图识别，因此被纳入研究，作为阳性对照以展示模型在检测通过心电图诊断的疾病中的有效性。

==预测模型的目标是输出校准后的概率，针对每种疾病提供预测==。这些学习模型可使用在医疗事件中的任何时间点获取的心电图。在模型训练过程中，我们==**使用了所有心电图数据（tip：感觉这样做不太合适）**==（包括同一医疗事件中获取的多份心电图），以最大化学习效果。然而，在模型评估时，我们仅使用给定医疗事件中的首次心电图，以模拟在急诊或住院期间首次获取的心电图的预测场景（详见“评估”部分）。

我们使用了==基于ResNet的深度学习（DL）模型处理包含丰富信息的电压-时间序列数据==，并使用了==基于梯度提升（XGB）的模型处理心电图测量值==【25】。为了确定人口统计特征（如年龄和性别）是否对仅基于心电图的模型性能有额外的预测价值，==我们开发并报告了以下三类模型：(a) 仅基于心电图（DL: ECG trace）；(b) 基于心电图、年龄和性别（DL: ECG trace, age, sex，这是本文的主要模型）；以及(c) XGB模型：基于心电图测量值、年龄和性别。==

**学习算法** 
我们采用了==多标签分类方法==，对每种疾病的存在与否进行二分类预测，以估计新患者患有这些疾病的概率。

==由于使用心电图测量值的模型输入的是结构化表格数据，我们为每个疾病标签训练了独立的梯度提升树集成模型（XGB）==【38】，而==对于处理心电图电压-时间序列数据的模型，我们使用了深度卷积神经网络模型==。对于XGB和DL模型，我们使用90%的数据进行训练，其余10%作为调优集，以跟踪性能损失并在合适的时间点“早停”，从而减少过拟合的可能性【39】。对于深度学习，我们==使用了单一的ResNet模型，进行多分类多标签任务==，将每份心电图信号映射为15个值，对应于每种疾病的概率。而对于XGB模型，我们为每个标签独立训练了15个二分类模型，分别预测每个疾病的概率。

**评估与可视化** 
**评估设计：**我们将数据集随机分为60%的模型开发集（其中包括五折内部交叉验证用于模型训练和微调）和40%的外部验证集。我们确保同一患者的心电图不会同时出现在开发和评估集之间，也不会出现在交叉验证的训练和测试折之间。如前所述，由于我们希望该预测系统能够在医疗场景中使用，因此我们评估模型时仅使用患者在急诊或住院期间首次获取的心电图。心电图、医疗事件和患者的数量见图1和补充表5。

除了主要评估外，我们还扩展了测试范围，包含所有在验证集中获取的心电图，以展示DL模型处理医疗事件期间任意时间点获取的心电图的多样性。

此外，我们还通过“留一医院验证”使用两家大型三级医院进行测试，以评估模型在不同医院分布差异下的稳健性。为了保证训练和测试集的完全分离，我们排除了在研究期间既住院于训练医院又住院于测试医院的患者心电图数据，具体见补充图1。最后，为了强调DL模型在筛查场景中的适用性，我们将15种疾病标签整合为一个复合预测，以提高诊断效率【20】。

我们报告了受试者工作特征曲线下面积（AUROC，等同于C-index）和精确召回曲线下面积（AUPRC），同时通过将预测概率二值化为诊断/非诊断类别，生成F1分数、特异性、召回率、精确度（等同于PPV）和准确率。我们还使用了校准指标Brier Score【41】（分数越小校准越好）来评估预测概率是否与实际比例相符。

**性别与起搏器子群分析** 
我们还评估了模型在特定患者子群中的表现，基于患者性别进行划分。我们还分析了在存在心脏起搏器（包括植入式心脏复律除颤器[ICD]）或心室辅助装置（VAD）的情况下，模型的表现是否受到影响，比较了无起搏器的心电图与包含或不包含起搏器的整体测试集中模型的性能（见图1）。用于识别起搏器的诊断和手术代码见补充表7。

**模型比较** 
在每次评估中，我们报告了五折内部交叉验证的性能以及在测试集中的最终性能。我们通过有放回抽样的方法比较模型性能，每次抽样比较无起搏器与原始数据集的模型，生成10,000个成对AUROC差异的自助法重复样本。若AUROC差异的95%置信区间不包含零，则模型性能差异具有统计学意义。

**可视化**

我们基于信息增益的特征重要性值，确定了在XGB模型中对诊断预测贡献最大的心电图测量值。此外，针对深度学习模型，我们使用了基于梯度加权类激活映射（GradCAM）的方法，在最后一层卷积层上可视化了对模型诊断预测贡献最大的激活映射区域【42】。同时，我们还再次利用基于信息增益的特征重要性值，识别出在XGB模型中对诊断预测贡献最大的心电图测量值。